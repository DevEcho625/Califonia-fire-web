<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CA Wildfire Risk Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body,html{margin:0;height:100%;font-family:system-ui,Arial}
    #map{height:100%}
    .legend{
      padding:8px 12px;
      background:#fff;
      border-radius:4px;
      box-shadow:0 0 4px rgba(0,0,0,.3);
      line-height:1.4;
    }
    .legend i{width:18px;height:18px;float:left;margin-right:8px;opacity:.8}
    .info{
      padding:6px 8px;
      font:14px/16px Arial,Helvetica,sans-serif;
      background:white;
      border-radius:4px;
      max-width:300px;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>
<script>
/* ---------- CONFIG ---------- */
const frapGeoJson = 'https://opendata.arcgis.com/api/v3/datasets/0b711d3faaba4185996ecf4c2b30d3c5_0/downloads/data?format=geojson&spatialRefId=4326'; // 1950-2022 perimeters
const viirsCsv     = 'https://firms.modaps.eosdis.nasa.gov/api/area/csv/2440c64e34d3b88a5e82a31025a376da/VIIRS_SNPP_NRT/1/2025-09-28'; // last 24 h (replace date)

/* ---------- BASE MAP ---------- */
const map = L.map('map').setView([37.0,-119], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OSM contributors'
}).addTo(map);

/* ---------- FIRE HAZARD SEVERITY TILES (2022) ---------- */
L.esri.tiledMapLayer({
  url:'https://tiles.arcgis.com/tiles/4yjifSiIG17X0gW4/arcgis/rest/services/Fire_Hazard_Severity_Zones_2022/MapServer',
  maxZoom:16,
  opacity:0.7
}).addTo(map);

/* ---------- HISTORICAL PERIMETERS ---------- */
fetch(frapGeoJson)
  .then(r=>r.json())
  .then(geojson=>{
    L.geoJson(geojson,{
      style:()=>({color:'#6b0f0f',weight:1.5,opacity:.35,fillOpacity:.05}),
      onEachFeature:(f,l)=>{
        l.bindPopup(`<b>${f.attributes.FIRE_NAME||'unknown'}</b><br>
                      Year: ${f.attributes.YEAR_}<br>
                      Acres: ${Math.round(f.attributes.ACRES)}`);
      }
    }).addTo(map);
  });

/* ---------- LIVE HOTSPOTS (VIIRS) ---------- */
function csv2geo(csv){
  const lines=csv.trim().split('\n').slice(1);
  return {
    type:'FeatureCollection',
    features:lines.map(r=>{
      const c=r.split(',');
      return {
        type:'Feature',
        geometry:{type:'Point',coordinates:[+c[2],+c[1]]},
        properties:{confidence:+c[8],frp:+c[9],acq_date:c[6]}
      };
    })
  };
}
fetch(viirsCsv)
  .then(r=>r.text())
  .then(txt=>{
    const geo=csv2geo(txt);
    L.geoJson(geo,{
      pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:4,weight:1,color:'orangered',fillOpacity:.8})
        .bindPopup(`Confidence: ${f.properties.confidence}%<br>FRP: ${f.properties.frp} MW`)
    }).addTo(map);
  });

/* ---------- SIMPLE LEGEND ---------- */
const legend = L.control({position:'bottomleft'});
legend.onAdd=function(){
  const div=L.DomUtil.create('div','legend');
  div.innerHTML+= '<b>Fire Hazard Severity</b><br>';
  div.innerHTML+= '<i style="background:#fee5d9"></i> Moderate<br>';
  div.innerHTML+= '<i style="background:#fcae91"></i> High<br>';
  div.innerHTML+= '<i style="background:#cb181d"></i> Very High<br>';
  div.innerHTML+= '<i style="background:#6b0f0f;border:1px solid #fff"></i> Historic burn<br>';
  div.innerHTML+= '<i style="background:orangered;border-radius:50%"></i> 24 h hotspot';
  return div;
};
legend.addTo(map);
</script>
</body>
</html>